<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width">

    <link rel="alternate" type="application/rss+xml" title="Jeremy Tuloup's Blog" href="http://www.jtp.io/feed.xml">

    <title>Jeremy Tuloup's Blog - JS1K 2015 postmortem</title>

    <link rel="shortcut icon" type="image/png" href="favicon.png"/>

    <!-- Bootstrap core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.5/yeti/bootstrap.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
    <style>
      .MathJax_Preview { color: #888 }
      .math_finished .MathJax_Preview { display: none }
    </style>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>
    <div id="top" class="container">

<div class="navbar navbar-default">
    <div class="container-fluid">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">JTP 1/0</a>
  </div>
  <div class="navbar-collapse navbar-responsive-collapse collapse" style="height: 1px;">
    <ul class="nav navbar-nav">
      
        
          
        
          
        
          
        
          
            
              <li><a href="/index.html">Hi</a></li>
            
          
        
      
        
          
            
              <li><a href="/blog.html">Blog</a></li>
            
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
            
              <li><a href="/gameJams.html">Game Jams</a></li>
            
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
      
    </ul>

    <ul class="nav navbar-nav navbar-right">
        <li>
            <a href="https://github.com/jtpio" title="Github"><i class="fa fa-github-square fa-1x"></i></a>
        </li>
        <li>
            <a href="https://twitter.com/jtpio" title="Twitter"><i class="fa fa-twitter-square fa-1x"></i></a>
        </li>
        <li>
        <a href="http://www.linkedin.com/in/jtuloup" title="LinkedIn"><i class="fa fa-linkedin-square fa-1x"></i></a>
        </li>
    </ul>
  </div>
  </div>
</div>


<div class="row">
  <div class="col-md-12 col-xs-18 col-sm-12">
	  <h2> <strong> JS1K 2015 postmortem </strong> &ndash; March 24, 2015 </h2>
<h4>

	<span class="label label-default">javascript</span>

	<span class="label label-default">webgl</span>

	<span class="label label-default">demo</span>

</h4>

<h1 id="tldr">TL;DR</h1>

<p>Name: <strong>The Hub</strong></p>

<p><strong>[RECOMMENDED]</strong> Live demo (low quality but runs better): <a href="http://www.jtp.io/js1k-2015/">http://www.jtp.io/js1k-2015/</a></p>

<p>Demo entry (requires a good graphics card) : <a href="http://js1k.com/2015-hypetrain/details/2179">http://js1k.com/2015-hypetrain/details/2179</a></p>

<p>Source code: <a href="https://github.com/jtpio/js1k-2015">https://github.com/jtpio/js1k-2015</a></p>

<p><img class="center" alt="The Hub" src="/res/js1k_2015/16_lights_off.png" /></p>

<p>If you want to know more about the making of this demo, keep reading.</p>

<h1 id="table-of-contents">Table of Contents</h1>
<ul>
  <li><a href="#part-1">Joining the competition</a></li>
  <li><a href="#part-2">Inspiration</a></li>
  <li><a href="#part-3">Workflow</a></li>
  <li><a href="#part-4">Timelapse</a></li>
  <li><a href="#part-5">Implementation</a></li>
  <li><a href="#part-6">Wrapping up</a></li>
  <li><a href="#part-7">References</a></li>
</ul>

<h1 id="joining-the-competition-a-idpart-1a">Joining the competition <a id="part-1"></a></h1>

<p>This year I decided to enter the <a href="http://js1k.com">JS1K</a> online competition (make something less than 1024 bytes of pure JS).</p>

<p>I had joined the party two years ago and did something in 2D (<a href="http://js1k.com/1344">http://js1k.com/1344</a>)</p>

<p>The new rules for this year allowed the use of WebGL, which was good because I had a list of <strong>new stuff I wanted to learn</strong>:</p>

<ul>
  <li>Do something in 3D</li>
  <li>In WebGL</li>
  <li>Learn more about shader programming</li>
  <li>Implement a raymarching algorithm</li>
  <li>Implement a cartoony effect (toon shading)</li>
</ul>

<p>The theme was <strong>Hype Train</strong>. After a few days of wandering and research for inspiration, I decided to go for a demo that will consist of a <strong>raymarched</strong> scene of trains, continuously moving, rendered with a <strong>toon shading</strong> effect.</p>

<h2 id="inspiration-a-idpart-2a">Inspiration <a id="part-2"></a></h2>

<p>I wanted to do something with futuristic trains, or at least related to futuristic transportation, but not necessarily realistic.</p>

<p>In the beginning I wanted to have a transparent tube with trains / objects moving inside the tube, like the Futurama transport tubes or the first picture below. But I dropped the idea quickly because of the potential complexity of doing transparency.</p>

<p><img class="center" src="//i2.cdn.turner.com/cnnnext/dam/assets/130717103845-tube-transport-2-horizontal-large-gallery.jpg" />
Source: <a href="http://i2.cdn.turner.com/cnnnext/dam/assets/130717103845-tube-transport-2-horizontal-large-gallery.jpg">http://i2.cdn.turner.com/cnnnext/dam/assets/130717103845-tube-transport-2-horizontal-large-gallery.jpg</a></p>

<p><img class="center" src="//fc04.deviantart.net/fs50/f/2009/315/2/2/Vinean_Maglev_Train_by_UweG.jpg" />
Source: <a href="http://fc04.deviantart.net/fs50/f/2009/315/2/2/Vinean_Maglev_Train_by_UweG.jpg">http://fc04.deviantart.net/fs50/f/2009/315/2/2/Vinean_Maglev_Train_by_UweG.jpg</a></p>

<p><img class="center" src="//photos1.blogger.com/blogger/1648/2486/1600/Tube.jpg" />
Source: <a href="http://photos1.blogger.com/blogger/1648/2486/1600/Tube.jpg">http://photos1.blogger.com/blogger/1648/2486/1600/Tube.jpg</a></p>

<h2 id="workflow-a-idpart-3a">Workflow <a id="part-3"></a></h2>

<p>I made the demo in basically two weeks, working mostly during the evenings. The time constraints were pretty tough because at the time the contest was supposed to only last one month, and I would also be away (and away from keyboard) the last week of February. It was essential to have good tools and a good flow.</p>

<p>I got things started with this very useful JS1K boilerplate: <a href="https://gist.github.com/gre/9364718">https://gist.github.com/gre/9364718</a>.</p>

<p>To be sure that my demo will work in the final skim, I extended this boilerplate to automate it even more, and include the shader minification step.</p>

<ol>
  <li>The shader is mainly developed on <a href="http://shadertoy.com">shadertoy</a>, to have a quick feedback and to prototype fast</li>
  <li>I copy/paste the code from shadertoy to a local file</li>
  <li>The shader source code is processed by a replacement tool to rename the global variables used on shadertoy (iGlobalTime to T, iResolution to R). Then it is minified with <a href="http://www.ctrl-alt-test.fr/?page_id=7">shader minifer</a></li>
  <li>The minified shader source is copied to the main Javascript code and stored as a variable (string)</li>
  <li>UglifyJS minifies the code</li>
  <li>jscrush crushes the code</li>
  <li>The crushed code is inserted in a <em>script</em> tag in the shim.html file which produces an index.html file.</li>
  <li>Open the index.html in a web browser</li>
</ol>

<p><img class="center" src="/res/js1k_2015/flow.png" /></p>

<p>I forked the gist mentioned above and extended it to fit my requirements: <a href="https://gist.github.com/jtpio/547db4510c0bec05bed5">https://gist.github.com/jtpio/547db4510c0bec05bed5</a>. It is probably possible to improve it, so feel free to do so!</p>

<p>I also used a board on Trello to organize ideas and progress.</p>

<p><img class="center" src="/res/js1k_2015/trello_dashboard.png" /></p>

<h2 id="timelapse-a-idpart-4a">Timelapse <a id="part-4"></a></h2>

<p>Because it’s always fun to visualize, here is a quick timelapse to show how things changed over time.</p>

<h3 id="render-basic-stuff-to-be-more-familiar-with-raymarching">Render basic stuff to be more familiar with raymarching</h3>
<p><img class="center" src="/res/js1k_2015/1_ray_march.png" /></p>

<h3 id="then-some-colors-and-lighting-inspired-by-iq-primitives-shaderhttpswwwshadertoycomviewxds3zn">Then some colors and lighting inspired by <a href="https://www.shadertoy.com/view/Xds3zN">iq primitives shader</a></h3>
<p><img class="center" src="/res/js1k_2015/1_ray_march_colors.png" /></p>

<h3 id="toon-shading-is-implemented">Toon shading is implemented</h3>
<p><img class="center" src="/res/js1k_2015/3_cell_shading.png" /></p>

<h3 id="does-it-look-better-with-a-ground-hmm-no">Does it look better with a ground? Hmm no.</h3>
<p><img class="center" src="/res/js1k_2015/4_trying_new_colors.png" /></p>

<h3 id="different-tracks-and-colors">Different tracks and colors</h3>
<p><img class="center" src="/res/js1k_2015/5_several_tracks.png" /></p>

<h3 id="vertical-trains-dark-theme">Vertical trains, dark theme</h3>
<p><img class="center" src="/res/js1k_2015/6_different_orientations.png" /></p>

<h3 id="camera-tweaks-1">Camera tweaks 1</h3>
<p><img class="center" src="/res/js1k_2015/9_three_trakcs.png" /></p>

<h3 id="camera-tweaks-2">Camera tweaks 2</h3>
<p><img class="center" src="/res/js1k_2015/11_getting_there2.png" /></p>

<h3 id="positioning-of-the-tracks">Positioning of the tracks</h3>
<p><img class="center" src="/res/js1k_2015/12_getting_there_screenshot.png" /></p>

<h3 id="started-the-manual-size-optimization">Started the manual size optimization</h3>

<p>You can notice that I dropped the “squared” shapes for something more round, in the form of a cylinder. The function used to generate this is indeed way shorter in the latter case.
<img class="center" src="/res/js1k_2015/13_downgrading_1088B.png" /></p>

<h3 id="light-work">Light work</h3>

<p>The source light is positioned higher. But as you can see there is no ambient occlusion :(
<img class="center" src="/res/js1k_2015/14_1042_viz.png" /></p>

<h3 id="colors-changing-over-time">Colors changing over time</h3>

<p>This was actually a very cheap improvement in terms of code size (just of few bytes).
<img class="center" src="/res/js1k_2015/16_lights_off.png" /></p>

<h2 id="implementation-a-idpart-5a">Implementation <a id="part-5"></a></h2>

<p>The demo consists of one shader (vertex + fragment) displayed full screen. The fragment and vertex shaders are loaded with a tiny piece of WebGL code, mainly inspired by the awesome work of <strong>½-bit Cheese</strong> on <a href="http://www.pouet.net/prod.php?which=61667">HBC-00012: Kornell Box</a>.</p>

<p>Here is the WebGL code without the shaders. I managed to save a few bytes by re-using variable names used in the shader code (for example <em>x</em>) in the following WebGL code, so it compresses better. What I mean is that if you take the variable <em>x</em> below in the <em>for</em> loop, you can technically replace it by any other variable name. Since <em>x</em> was used a lot in the fragment shader code, I decided to use it again, but it could also be <em>a</em>, <em>z</em>, <em>l</em> …</p>

<p>Constants like <em>g.FRAGMENT_SHADER</em> or <em>g.ARRAY_BUFFER</em> are replaced by their numerical values. The for loop produces 2 iterations, one to setup the vertex shader and another one to setup the fragment shader, and the variable <em>y</em> decides which shader to load.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// shorten the functions</span>
<span class="k">for</span><span class="p">(</span><span class="nx">x</span> <span class="k">in</span> <span class="nx">g</span><span class="p">)</span>
  <span class="nx">g</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^..|[A-V]/g</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)]</span><span class="o">=</span><span class="nx">g</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span>

<span class="kd">with</span><span class="p">(</span><span class="nx">g</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">x</span><span class="o">=</span><span class="nx">crP</span><span class="p">(</span><span class="nx">y</span><span class="o">=</span><span class="nx">v</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span><span class="nx">y</span><span class="p">;</span><span class="nx">coS</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span><span class="nx">atS</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">n</span><span class="p">))</span>
        <span class="nx">shS</span><span class="p">(</span><span class="nx">n</span><span class="o">=</span><span class="nx">crS</span><span class="p">(</span><span class="mi">35634</span><span class="o">-</span><span class="nx">y</span><span class="p">),</span>

        <span class="o">--</span><span class="nx">y</span><span class="o">?</span>
        <span class="c1">// insert fragment shader</span>
        <span class="o">:</span>
        <span class="c1">// insert vertex shader</span>
        <span class="p">);</span>

    <span class="nx">veAP</span><span class="p">(</span><span class="nx">enVAA</span><span class="p">(</span><span class="nx">biB</span><span class="p">(</span><span class="mi">34962</span><span class="p">,</span><span class="nx">crB</span><span class="p">())),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5126</span><span class="p">,</span> <span class="nx">liP</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">usP</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span>
        <span class="nx">buD</span><span class="p">(</span><span class="mi">34962</span><span class="p">,</span><span class="k">new</span> <span class="nx">Float32Array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="mi">35044</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="nx">setInterval</span><span class="p">(</span>
        <span class="s1">&#39;g.drA(4,g.uniform1f(g.geUL(x,&quot;T&quot;),v+=.01),3)&#39;</span><span class="p">,</span>
        <span class="mi">33</span><span class="p">)</span>
<span class="p">};</span></code></pre></div>

<p>The first two lines map all the function names from the webgl context to shorter function names. You can visualize the mapping by opening the developer console, creating a canvas an running the following:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;webgl&#39;</span><span class="p">)</span>

<span class="k">for</span><span class="p">(</span><span class="nx">x</span> <span class="k">in</span> <span class="nx">g</span><span class="p">)</span>
  <span class="nx">g</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^..|[A-V]/g</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span><span class="o">=</span><span class="nx">g</span><span class="p">[</span><span class="nx">x</span><span class="p">];</span></code></pre></div>

<p>Exploring the webgl context (variable g) will give something like this, and will help to understand what <em>enVAA</em>, <em>biB</em> or <em>atS</em> actually mean:</p>

<p><img class="center" src="/res/js1k_2015/webgl_map.png" /></p>

<p>It’s pretty short, but it is roughly the equivalent of this:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">vs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// insert vertex shader</span>
<span class="nx">fs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// insert fragment shader</span>

<span class="nx">p</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">createProgram</span><span class="p">();</span>
<span class="nx">shader</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">VERTEX_SHADER</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">shaderSource</span><span class="p">(</span><span class="nx">shader</span><span class="p">,</span> <span class="nx">vs</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">compileShader</span><span class="p">(</span><span class="nx">shader</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="nx">shader</span><span class="p">);</span>
<span class="nx">shader</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">FRAGMENT_SHADER</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">shaderSource</span><span class="p">(</span><span class="nx">shader</span><span class="p">,</span> <span class="nx">fs</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">compileShader</span><span class="p">(</span><span class="nx">shader</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="nx">shader</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">linkProgram</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>

<span class="nx">pLocation</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="s2">&quot;p&quot;</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span><span class="nx">g</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">());</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span><span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span>
  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
   <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
   <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span><span class="nx">g</span><span class="p">.</span><span class="nx">STATIC_DRAW</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span><span class="nx">pLocation</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span><span class="nx">pLocation</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="nx">g</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="nx">tLocation</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="s1">&#39;iGlobalTime&#39;</span><span class="p">);</span>

<span class="nx">initTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="p">(</span><span class="kd">function</span> <span class="nx">draw</span><span class="p">(){</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span><span class="nx">tLocation</span><span class="p">,(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="o">-</span><span class="nx">initTime</span><span class="p">)</span><span class="o">*</span><span class="mf">0.001</span><span class="p">);</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">draw</span><span class="p">);</span>
<span class="p">})();</span></code></pre></div>

<h3 id="original-shader-source-code">Original shader source code</h3>

<p>The fragment shader used before the minification, with comments, is quite verbose:</p>

<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">T</span><span class="p">;</span>

<span class="c1">// union</span>
<span class="k">vec2</span> <span class="n">opU</span><span class="p">(</span> <span class="k">vec2</span> <span class="n">d1</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">d2</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d1</span><span class="p">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">d2</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">?</span> <span class="n">d1</span> <span class="o">:</span> <span class="n">d2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// rotate pos around y</span>
<span class="k">vec3</span> <span class="n">rotate</span> <span class="p">(</span><span class="k">vec3</span> <span class="n">pos</span><span class="p">,</span> <span class="k">float</span> <span class="n">angle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">mat3</span> <span class="n">m</span> <span class="o">=</span> <span class="k">mat3</span><span class="p">(</span>
        <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
        <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// the train that is moving along the tracks</span>
<span class="k">vec2</span> <span class="n">train</span> <span class="p">(</span><span class="k">vec3</span> <span class="n">pos</span><span class="p">,</span> <span class="k">float</span> <span class="n">yPos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">vec3</span> <span class="n">t</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>

    <span class="c1">// y offset</span>
    <span class="n">t</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">yPos</span><span class="p">;</span>
    <span class="c1">// moving train</span>
    <span class="n">t</span><span class="p">.</span><span class="n">z</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">40.0</span> <span class="o">+</span> <span class="n">mod</span><span class="p">(</span><span class="n">iGlobalTime</span> <span class="o">*</span> <span class="n">yPos</span> <span class="o">*</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">);</span>

    <span class="c1">// a function for a capped cylinder is used to represent the train</span>
    <span class="k">return</span> <span class="n">abs</span><span class="p">(</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">xy</span><span class="p">),</span> <span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">))</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">float</span> <span class="n">track</span> <span class="p">(</span><span class="k">vec3</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// a track is an infinite cylinder</span>
    <span class="k">return</span> <span class="n">length</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">yx</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// distance function for the raymarching</span>
<span class="k">vec2</span> <span class="n">map</span><span class="p">(</span><span class="k">vec3</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">vec2</span> <span class="n">res</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
    <span class="c1">// this iteration will spawn 5 tracks, rotated around the y axis and with a different y position</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">float</span> <span class="n">i</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mf">11.1</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mf">2.2</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// this rotation gives the illusion that the camera is rotating, whereas it is actually the tracks that are rotating.</span>
        <span class="k">vec3</span> <span class="n">rotated</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">iGlobalTime</span><span class="p">);</span>
        <span class="k">vec3</span> <span class="n">trackPos</span> <span class="o">=</span> <span class="n">rotated</span><span class="p">;</span>
        <span class="n">trackPos</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">float</span> <span class="n">trackDist</span> <span class="o">=</span> <span class="n">track</span><span class="p">(</span><span class="n">trackPos</span><span class="p">);</span>

        <span class="k">vec2</span> <span class="n">d</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">rotated</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="c1">// take the union of all the objects in the scene to find out if something has been hit or not</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opU</span><span class="p">(</span>
                <span class="n">res</span><span class="p">,</span> <span class="c1">// previous</span>
                <span class="n">opU</span><span class="p">(</span>
                    <span class="n">opU</span><span class="p">(</span>
                        <span class="k">vec2</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)),</span> <span class="mi">38</span><span class="p">),</span>
                        <span class="k">vec2</span><span class="p">(</span><span class="n">trackDist</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
                    <span class="c1">// the torus along the tube</span>
                    <span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">trackPos</span><span class="p">.</span><span class="n">xy</span><span class="p">)</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">mod</span><span class="p">(</span><span class="n">trackPos</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span><span class="o">-</span><span class="mf">2.0</span><span class="p">))</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
              <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">void</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">float</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

    <span class="c1">// center everything</span>
    <span class="k">vec2</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">gl_FragCoord</span><span class="p">.</span><span class="n">xy</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

    <span class="k">vec3</span> <span class="n">origin</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">);</span>
    <span class="k">vec3</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

    <span class="c1">// raymarch</span>
    <span class="k">float</span> <span class="n">res</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span><span class="o">=</span><span class="mo">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">origin</span><span class="o">+</span><span class="n">dest</span><span class="o">*</span><span class="n">t</span><span class="p">).</span><span class="n">x</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">60.0</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">vec3</span> <span class="n">color</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// nothing was hit, render black</span>
        <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// something was hit</span>
        <span class="c1">// 1. Calculate the normal for the shading</span>
        <span class="c1">// 2. Do the toon shading</span>
        <span class="c1">// 3. Calculate the color at the point of contact</span>

        <span class="k">vec3</span> <span class="n">eps</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="mo">0</span><span class="p">);</span>
        <span class="k">vec3</span> <span class="n">hit</span> <span class="o">=</span> <span class="n">origin</span><span class="o">+</span><span class="n">dest</span><span class="o">*</span><span class="n">t</span><span class="p">;</span>

        <span class="c1">// calculate the normal</span>
        <span class="k">vec3</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span>
            <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">+</span><span class="n">eps</span><span class="p">.</span><span class="n">xyy</span><span class="p">).</span><span class="n">x</span> <span class="o">-</span> <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">-</span><span class="n">eps</span><span class="p">.</span><span class="n">xyy</span><span class="p">).</span><span class="n">x</span><span class="p">,</span>
            <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">+</span><span class="n">eps</span><span class="p">.</span><span class="n">yxy</span><span class="p">).</span><span class="n">x</span> <span class="o">-</span> <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">-</span><span class="n">eps</span><span class="p">.</span><span class="n">yxy</span><span class="p">).</span><span class="n">x</span><span class="p">,</span>
            <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">+</span><span class="n">eps</span><span class="p">.</span><span class="n">yyx</span><span class="p">).</span><span class="n">x</span> <span class="o">-</span> <span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="o">-</span><span class="n">eps</span><span class="p">.</span><span class="n">yyx</span><span class="p">).</span><span class="n">x</span> <span class="p">));</span>

        <span class="c1">// toon shading</span>
        <span class="k">vec3</span> <span class="n">light</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mo">0</span><span class="p">));</span>
        <span class="k">float</span> <span class="n">df</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">light</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="n">df</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span> <span class="n">df</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">)</span> <span class="n">df</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
        <span class="k">float</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">light</span><span class="p">));</span>

        <span class="n">color</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">iGlobalTime</span> <span class="o">+</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">map</span><span class="p">(</span><span class="n">hit</span><span class="p">).</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">df</span> <span class="o">+</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">sf</span><span class="o">*</span><span class="n">sf</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>

<span class="p">}</span></code></pre></div>

<h3 id="minified-shader-source-code">Minified shader source code</h3>

<p>It’s pretty hard to minify a shader manually. Most of the tricks that apply to Javascript as you can find in a classic JS1K compo don’t apply for GLSL. This is because GLSL is in fact a bit like the C language, variables need to be correctly defined with types and it has a strict syntax.</p>

<p>The main strategy I chose to follow in order to reduce the size was to:</p>

<ol>
  <li><strong>Inline</strong> most of the functions.</li>
  <li><strong>Duplicate</strong> code. This is sad because it had a big impact on the overall performance, but in the end it really helped to compress better.</li>
  <li>Use <strong>manual tricks</strong>, for example approximate a three-digits number to a two-digits one when possible (100 -&gt; 99).</li>
</ol>

<p>After a manual minification and a pass through shader-minifier, I ended up with the following shader code. It’s a lot of duplicated code, but it compresses better with jscrush, even though it might sound counter intuitive.</p>

<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">T</span><span class="p">;</span>
<span class="k">vec2</span> <span class="n">v</span><span class="p">(</span><span class="k">vec2</span> <span class="n">x</span><span class="p">,</span><span class="k">vec2</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">?</span><span class="n">x</span><span class="o">:</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">vec2</span> <span class="n">v</span><span class="p">(</span><span class="k">vec3</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">vec2</span> <span class="n">x</span><span class="o">=</span><span class="k">vec2</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
 <span class="k">for</span><span class="p">(</span><span class="k">float</span> <span class="n">n</span><span class="o">=</span><span class="mf">1.</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;</span><span class="mf">11.1</span><span class="p">;</span><span class="n">n</span><span class="o">+=</span><span class="mf">2.2</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="k">vec2</span> <span class="n">c</span><span class="o">=</span><span class="n">abs</span><span class="p">(</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xy</span><span class="p">),</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="mf">40.</span><span class="o">+</span><span class="n">mod</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="mf">8.</span><span class="p">,</span><span class="mf">90.</span><span class="p">)))</span><span class="o">-</span><span class="k">vec2</span><span class="p">(</span><span class="mf">.7</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
     <span class="n">x</span><span class="o">=</span><span class="n">v</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="k">vec2</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="mf">0.</span><span class="p">)</span><span class="o">+</span><span class="n">length</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mf">0.</span><span class="p">)),</span><span class="mi">38</span><span class="p">),</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">yx</span><span class="p">)</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xy</span><span class="p">)</span><span class="o">-</span><span class="mf">.9</span><span class="p">,</span><span class="n">mod</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">4.</span><span class="p">)</span><span class="o">-</span><span class="mf">2.</span><span class="p">))</span><span class="o">-</span><span class="mf">.2</span><span class="p">,</span><span class="mi">5</span><span class="p">)));</span>
   <span class="p">}</span>
 <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">void</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
 <span class="k">float</span> <span class="n">n</span><span class="o">=</span><span class="mf">1.</span><span class="p">;</span>
 <span class="k">vec2</span> <span class="n">y</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">gl_FragCoord</span><span class="p">.</span><span class="n">xy</span><span class="o">/</span><span class="n">R</span><span class="p">.</span><span class="n">xy</span><span class="o">-</span><span class="n">n</span><span class="p">;</span>
 <span class="n">y</span><span class="p">.</span><span class="n">x</span><span class="o">*=</span><span class="n">R</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">R</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
 <span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">x</span><span class="o">=</span><span class="mo">0</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">;</span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="p">).</span><span class="n">x</span><span class="o">&lt;</span><span class="mf">.01</span><span class="o">||</span><span class="n">n</span><span class="o">&gt;</span><span class="mf">60.</span><span class="p">)</span>
       <span class="k">break</span><span class="p">;</span>
     <span class="n">n</span><span class="o">+=</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="p">).</span><span class="n">x</span><span class="p">;</span>
   <span class="p">}</span>
 <span class="k">vec3</span> <span class="n">x</span><span class="o">=</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">xyy</span><span class="p">).</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">xyy</span><span class="p">).</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">yxy</span><span class="p">).</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">yxy</span><span class="p">).</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">yyx</span><span class="p">).</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.01</span><span class="p">,</span><span class="mo">0</span><span class="p">,</span><span class="mo">0</span><span class="p">).</span><span class="n">yyx</span><span class="p">).</span><span class="n">x</span><span class="p">));</span>
 <span class="n">gl_FragColor</span><span class="o">=</span><span class="k">vec4</span><span class="p">(</span><span class="n">n</span><span class="o">&lt;</span><span class="mf">60.</span><span class="o">?</span><span class="mf">.5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="k">vec3</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.5</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">n</span><span class="p">).</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0</span><span class="p">))))</span><span class="o">&lt;</span><span class="mf">.1</span><span class="o">?</span><span class="mf">.1</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0</span><span class="p">))))</span><span class="o">&lt;</span><span class="mf">.3</span><span class="o">?</span><span class="mf">.3</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0</span><span class="p">))))</span><span class="o">&lt;</span><span class="mf">.7</span><span class="o">?</span><span class="mf">.7</span><span class="o">:</span><span class="mf">1.</span><span class="p">)</span><span class="o">+</span><span class="n">step</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0</span><span class="p">))))</span><span class="o">*</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">normalize</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0</span><span class="p">))))))</span><span class="o">:</span><span class="k">vec3</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span><span class="mf">1.</span><span class="p">);</span></code></pre></div>

<h3 id="compression">Compression</h3>

<p>The original source code is maybe a bit big due to all the duplicated code, but it compresses well. Part of the flow was the recap of all the JS files sizes after compiling / compressing, which ended up being essential to checl if a change was worth begin kept.</p>

<p><img class="center" src="/res/js1k_2015/code_size.png" /></p>

<p>To illustrate how effective the compression is and the strategy I decided to use, we can take an example of a shader code that “nicely” written, and one with code duplication.</p>

<p>Let’s use the <a href="https://gist.github.com/jtpio/547db4510c0bec05bed5">gist</a> mentioned above to minify / compress everything quickly.</p>

<p>For the example, let’s take a short shader made by iq for his <a href="https://www.youtube.com/watch?v=0ifChJ0nJfM">formulanimation tutorial</a>:</p>

<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">vec2</span> <span class="n">p</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
  <span class="k">vec2</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.7</span><span class="p">);</span>

  <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">);</span>

  <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span> <span class="n">atan</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">10.0</span> <span class="o">+</span> <span class="mf">20.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">);</span>
  <span class="n">col</span> <span class="o">*=</span> <span class="n">smoothstep</span><span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span> <span class="n">q</span> <span class="p">)</span> <span class="p">);</span>

  <span class="n">r</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">;</span>
  <span class="n">r</span> <span class="o">+=</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mf">120.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
  <span class="n">r</span> <span class="o">+=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">40.0</span><span class="o">*</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">col</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">smoothstep</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">))))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>

  <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>Running the tool on this shader (place the above code in the file <a href="https://gist.github.com/jtpio/547db4510c0bec05bed5#file-shader-fs">shader.fs</a>): <code>npm run all</code></p>

<p><img class="center" src="/res/js1k_2015/code_size_example1.png" /></p>

<p>What if instead we group the terms of the variable <em>r</em> and <em>col</em> together (inline), so the code is transformed to this?</p>

<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">vec2</span> <span class="n">p</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
  <span class="k">vec2</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.7</span><span class="p">);</span>

  <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">smoothstep</span><span class="p">(</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span> <span class="n">atan</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">10.0</span> <span class="o">+</span> <span class="mf">20.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span> <span class="n">atan</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">10.0</span> <span class="o">+</span> <span class="mf">20.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span> <span class="n">q</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.015</span> <span class="o">+</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mf">120.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">40.0</span><span class="o">*</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="mf">0.015</span> <span class="o">+</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mf">120.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">40.0</span><span class="o">*</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">))))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">)));</span>

  <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>Again, <code>npm run all</code>:
<img class="center" src="/res/js1k_2015/code_size_example2.png" /></p>

<p>The crushed code size has decreased by <strong>11 bytes</strong>, and the result is still the same. This case illustrates an example on how JSCrush takes advantage of duplicated code (pattern).</p>

<h2 id="wrapping-up-a-idpart-6a">Wrapping up <a id="part-6"></a></h2>

<p>I entered the competition quite relaxed, considering it as a personal challenge rather than a real competition. In fact I could say it was my February 30 Day Challenge, so it somehow forced myself not to give up before the end!</p>

<p>It was very fun and I learned <strong>a lot</strong> of new stuff, especially about 3D graphics, the <strong>raymarching algorithm</strong> and some <strong>shader programming</strong>.</p>

<p>One possible regret is that the overall performance is a bit low. The code duplication is one of the factors, but there are probably some other reasons. Anyway, it is still possible to run the demo in a smaller window (less pixels) to reach a better framerate.</p>

<p>Hopefully this recap gives enough insight into the making of the demo, or at least makes you want to do your own compo next time! If there is anything that I got wrong, or if you want more details about a specific part, please let me know.</p>

<hr />

<h2 id="references-a-idpart-7a">References <a id="part-7"></a></h2>

<p>There are so many good resources on the subject that came to be super useful. Too many so here are just a few:</p>

<ul>
  <li>The demos mentioned in Paulo Falcao’s JS1K compo: <a href="http://js1k.com/2014-dragons/details/1868">http://js1k.com/2014-dragons/details/1868</a>. These:
    <ul>
      <li>HBC-00012: Kornell Box - <a href="http://www.pouet.net/prod.php?which=61667">http://www.pouet.net/prod.php?which=61667</a></li>
      <li>HBC-00013: Highway 4k - <a href="http://www.pouet.net/prod.php?which=61668">http://www.pouet.net/prod.php?which=61668</a></li>
    </ul>
  </li>
  <li>iq reference on distance functions: <a href="http://iquilezles.org/www/articles/distfunctions/distfunctions.htm">http://iquilezles.org/www/articles/distfunctions/distfunctions.htm</a></li>
  <li>iq intro to raymarching: <a href="http://www.iquilezles.org/www/articles/terrainmarching/terrainmarching.htm">http://www.iquilezles.org/www/articles/terrainmarching/terrainmarching.htm</a></li>
  <li>p01 resources on <a href="http://www.p01.org">p01.org</a>, especially for the trick for shortening webgl functions, and also for inspiration in general</li>
  <li>All the <a href="http://js1k.com">JS1K demos</a> for the ideas and tricks from past demos.</li>
</ul>


<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'jtzp4'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</div>

  <div class="row col-md-12 col-xs-18 col-sm-12">
    <p><small>By <a href="#top">Jeremy Tuloup</a> &ndash; 2015 &ndash; Theme by <a href="http://bootswatch.com/">bootswatch</a> </small></p>
  </div>

  </div> <!-- /container -->

  <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>

  <script>
    var scripts = document.getElementsByTagName("script");
    for (var i = 0; i < scripts.length; i++) {
      /* TODO: keep going after an individual parse error. */
      var script = scripts[i];
      if (script.type.match(/^math\/tex/)) {
        var text = script.text === "" ? script.innerHTML : script.text;
        var options = script.type.match(/mode\s*=\s*display/) ?
                      {displayMode: true} : {};
        script.insertAdjacentHTML("beforebegin",
                                  katex.renderToString(text, options));
      }
    }
    document.body.className += " math_finished";
  </script>

  <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>

  <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-51952511-1");
      pageTracker._trackPageview();
    } catch(err) {}
  </script>

  </body>
</html>
